<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Eco-System Mode</title>

    <link rel="stylesheet" href="css/swiper.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="css/main.css">

    <style>
        .swiper-container {
            width: 100%;
            height: 300px;
            margin-left: auto;
            margin-right: auto;
        }
        .swiper-slide {
            background-size: cover;
            background-position: center;
        }
        .gallery-top {
            top: 40%;
            height: 65%;
            width: 65%;
        }
        .gallery-thumbs {
            position: absolute;
            bottom: 0;
            height: 20%;
            box-sizing: border-box;
            padding: 10px 0;
        }
        .gallery-thumbs .swiper-slide {
            width: 25%;
            height: 100%;
            opacity: 0.4;
        }
        .gallery-thumbs .swiper-slide-thumb-active {
            opacity: 1;
        }

        canvas#drawing {
            height: 100%;
            width: 100%;
            position: absolute;
        }
    </style>

</head>
<body>

<!-- Navbar (sit on top) -->
<div class="w3-top" style="z-index: 10000">
    <div class="w3-bar w3-white w3-wide w3-padding w3-card">
        <a href="#" class="w3-bar-item w3-button"><b></b> Speculative Explorer </a>
        <!-- Float links to the right. Hide them on small screens -->
        <div class="w3-right w3-hide-small">
            <a href="#about" class="w3-bar-item w3-button">About</a>
        </div>
    </div>
</div>

<!-- Swiper -->
<div class="swiper-container gallery-top center">
    <div class="swiper-wrapper">
        <div class="swiper-slide" style="background-image:url('res/image_set/Powers of Ten/images/1.jpg')"></div>
    </div>
    <!-- Add Arrows -->
    <div class="swiper-button-next swiper-button-white"></div>
    <div class="swiper-button-prev swiper-button-white"></div>
</div>

<div class="swiper-container gallery-thumbs">
    <div class="swiper-wrapper">
        <div class="swiper-slide connection-thumbnail" style="background-image:url('res/image_set/Powers of Ten/images/0.jpg')"></div>
        <div class="swiper-slide connection-thumbnail" style="background-image:url('res/image_set/Powers of Ten/images/1.jpg')"></div>
        <div class="swiper-slide connection-thumbnail" style="background-image:url('res/image_set/Powers of Ten/images/2.jpg')"></div>
        <div class="swiper-slide connection-thumbnail" style="background-image:url('res/image_set/Powers of Ten/images/3.jpg')"></div>
        <div class="swiper-slide connection-thumbnail" style="background-image:url('res/image_set/Powers of Ten/images/4.jpg')"></div>
        <div class="swiper-slide connection-thumbnail" style="background-image:url('res/image_set/Powers of Ten/images/5.jpg')"></div>
        <div class="swiper-slide connection-thumbnail" style="background-image:url('res/image_set/Powers of Ten/images/6.jpg')"></div>
        <div class="swiper-slide connection-thumbnail" style="background-image:url('res/image_set/Powers of Ten/images/7.jpg')"></div>
        <div class="swiper-slide connection-thumbnail" style="background-image:url('res/image_set/Powers of Ten/images/8.jpg')"></div>
        <div class="swiper-slide connection-thumbnail" style="background-image:url('res/image_set/Powers of Ten/images/9.jpg')"></div>
    </div>
</div>

<div>

    <div class='dot-bg'></div>
    <canvas id="drawing"></canvas>

</div>

<script src="js/swiper.js"></script>
<script src="js/utilities.js"></script>
<script>

    const imageSetData = JSON.parse(ajax('GET', 'res/test_data/imageset.json', false, (data)=>{})).imageset;
    const _testImgSet = imageSetData[0];

    const el_dotBg = document.querySelector('div.dot-bg');


    var galleryThumbs = new Swiper('.gallery-thumbs', {
        spaceBetween: 10,
        slidesPerView: 4,
        freeMode: true,
        watchSlidesVisibility: true,
        watchSlidesProgress: true,
        centeredSlides: true,
        grabCursor: true,
        /*on: {
            progress: function(p) {
                console.log('progress:', document.querySelector('#test_0').getBoundingClientRect().x, document.querySelector('#test_0').getBoundingClientRect().y);
            },
            sliderMove: function (evt) {
                console.log('sliderMove:', document.querySelector('#test_0').getBoundingClientRect().x, document.querySelector('#test_0').getBoundingClientRect().y);
            }
        }*/
    });
    /*var galleryTop = new Swiper('.gallery-top', {
        spaceBetween: 10,
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        thumbs: {
            swiper: galleryThumbs
        }
    });*/


    document.body.onmousemove = function(evt) {
        const halfH = document.documentElement.clientHeight /2;
        const halfW = document.documentElement.clientWidth /2;

        var pdx = 1 - evt.clientX / halfW;
        var pdy = 1 - evt.clientY / halfH;

        // console.log( evt.clientX + "," + evt.clientY
        //     + " | " + dx + "," + dy
        //     + " | " + pdx + "," + pdy);

        el_dotBg.style.transform =
            ' rotateX('+pdx*5+'deg) rotateY('+pdy*5+'deg)' +
            // ' skew('+-pdy*5+'deg,'+-pdx*5+'deg)' +
            ' translateX('+pdx*5+'px) translateY('+pdy*5+'px)';
    };

    const el_canvas = document.querySelector('canvas#drawing');
    el_canvas.width  = window.innerWidth;
    el_canvas.height = window.innerHeight;
    // Draw on canvas
    const g = el_canvas.getContext('2d');
    g.strokeStyle = '#adadad';
    function arrowArc(g, strokeSize, x1, y1, x2, y2) {
        if (strokeSize <= 0) {
            return;
        }

        g.beginPath();
        g.lineWidth = strokeSize;

        var midY = (y1 + y2) / 2;
        var sign = (y2 > y1 ? 1 : -1);
        y2 -= strokeSize / 2;

        var s1 = sign * 4;
        var s2 = sign * 5 ;
        g.moveTo(x1, y1);
        // Draw a little short straight line here
        g.lineTo(x1, y1+s1);
        // Draw bezier
        g.bezierCurveTo(x1, midY - s2, x2, midY - s2,    x2, y2-s2);
        g.lineTo(x2, y2);
        g.stroke();

    }

    arrowArc(g, 1, 90, 90, 200, 200);
    arrowArc(g, 1, 93, 90, 100, 200);

    const el_start = document.querySelector('div.gallery-top');
    var stroke_width = 5;

    function update_drawing(time) {

        var x1 = el_start.getBoundingClientRect().x + el_start.getBoundingClientRect().width / 2;
        const y1 = el_start.getBoundingClientRect().bottom;
        const el_ends = document.querySelectorAll('.connection-thumbnail');
        const step = Math.max(stroke_width-1, 1);
        x1 -= (el_ends.length / 2)*step;

        g.clearRect(0, 0, el_canvas.width, el_canvas.height);
        for (var i = 0; i < el_ends.length; i++) {
            x1 += step;
            const x2 = el_ends[i].getBoundingClientRect().x + el_ends[i].getBoundingClientRect().width / 2;
            const y2 = el_ends[i].getBoundingClientRect().top;

            var dist = Math.abs(x2 - document.body.clientWidth / 2);
            const vdist = document.body.clientWidth * 0.3;
            dist = vdist / Math.max(vdist, dist);
            arrowArc(g, stroke_width * dist, x1, y1, x2, y2);
        }

        window.requestAnimationFrame(update_drawing);
    }

    window.requestAnimationFrame(update_drawing);

</script>

</body>
</html>
