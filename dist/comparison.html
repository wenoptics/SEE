<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Scale Comparison Browser</title>

    <style>
        .swiper-container {
            width: 100%;
            /*margin-left: auto;*/
            /*margin-right: auto;*/
        }

        .swiper-container#swiper-container-h {
            height: 100%;
            position: fixed;
        }

        .swiper-slide {
            text-align: center;
            font-size: 18px;
            /*background: #fff;*/
            overflow: hidden;

            /* Center slide text vertically */
            display: -webkit-box;
            display: -ms-flexbox;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-box-align: center;
            -ms-flex-align: center;
            -webkit-align-items: center;
            align-items: center;
        }

        .swiper-slide-h {
            /*background-color: #dedede;*/
        }

        .swiper-container-v {
            height: 100vh;
        }

        .slide-v-container {
            /*height: 90%;*/
            border-width: 5px;
            border-style: solid;
            border-color: white;
            background-color: white;
            box-shadow: 0 0 12px 1px #8080806e;
        }

        .slide-img {
            height: 15vh;
            width: 15vh;
            object-fit: cover
        }

        /*@media only screen and (max-width: 640px) {
            !*600px and down*!
            .slide-img {
                height: 45vw;
                width: 45vw;
            }
        }
        @media only screen and (min-width: 640px) {
            !*640px and up*!
            .slide-img {
                height: 20vw;
                width: 20vw;
            }
        }
        @media only screen and (min-width: 1024px) {
            !*1024px and up*!
            .slide-img {
                height: 14vw;
                width: 14vw;
            }
        }*/

        .label-on-ecosystem {
            position: absolute;
            right: 0.5em;
            font-size: 2em;
            white-space: nowrap;
            display: block;
            z-index: 10000;
            color: white;
            text-shadow:
                    #533d4a 1px 1px, #533d4a 2px 2px, #533d4a 3px 3px,
                    #533d4a 1px 1px, #533d4a 2px 2px, #533d4a 3px 3px;
            transition: all 0.7s;
        }

        .swiper-slide-h.swiper-slide-active .label-on-ecosystem {
            opacity: 0.5;
            font-size: 1em;
            bottom: 0;
        }


        .swiper-slide-h:not(.swiper-slide-active) .swiper-slide-v:not(.swiper-slide-active) {
            opacity: 0.15;
        }
        .swiper-slide-v:not(.swiper-slide-active) {
            transform: scale(0.6);
        }

        .swiper-slide-h:not(.swiper-slide-active) .swiper-slide-v {
            transform: scale(0.6);
        }

        .swiper-slide-h:not(.swiper-slide-active) {
            opacity: 0.25;
        }
        .swiper-slide-h.swiper-slide-prev, .swiper-slide-h.swiper-slide-next{
            opacity: 0.65;
        }
        .swiper-slide-h.swiper-slide-active {
            /*Highlight stripe*/
            /*background-color: #f0f8ff91 !important;*/
            background: rgb(2,0,36);
            background: linear-gradient(90deg, transparent 0%, rgba(2, 0, 36, 0.1) 10%, rgba(9, 9, 121, 0.12) 35%, rgba(0, 212, 255, 0.14) 100%);
            opacity: 1 !important;
            transform: scale(1);
        }

        .ecoCover {
            position: absolute;
            height: 100%;
            width: 65%;
            right: 0;
            box-shadow: inset 13px 0px 13px 0px white;
            background: url(data/ImageSecure/image.php?id=197) center center no-repeat;
            background-size: cover;
            opacity: 0.1;

            /*background: rgb(2,0,36);*/
            /*background: linear-gradient(90deg, transparent 0%, rgba(2, 0, 36, 0.1) 10%, rgba(9, 9, 121, 0.12) 35%, rgba(0, 212, 255, 0.14) 100%);*/

        }




    </style>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/2.9.3/introjs.min.css"/>
    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.2/css/uikit.min.css" />
    <link rel="stylesheet" href="css/swiper.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="css/main.css"/>
    <!--<link rel="stylesheet" href="css/loader.css"/>-->

</head>
<body>

<!-- Navbar (sit on top) -->
<div class="w3-top" style="z-index: 10000">
    <div class="w3-bar w3-white w3-wide w3-padding w3-card">
        <a href="/" class="w3-bar-item w3-button"><b></b> Speculative Explorer </a>
        <!-- Float links to the right. Hide them on small screens -->
        <div class="w3-right w3-hide-small">
            <a href="upload.html" class="w3-bar-item w3-button" data-step="4" data-intro="Upload your ecosystem!">Upload</a>
            <a href="#" class="w3-bar-item w3-button" id="btn-start-guide">Guide</a>
            <a href="#about" class="w3-bar-item w3-button">About</a>
        </div>
    </div>
</div>

<div>

    <div class='dot-bg'></div>

    <div class="mode-widgets" data-step="2" data-intro="switch between modes."
         style="
        position: fixed; right: 10vw; top: 8vh;
        transform: skew(-10deg);z-index: 10000;
        border-bottom: 4px solid #00000033;
        border-right: 4px solid #00000033;">
        <!--todo Optimize for small screen-->
        <div style="background-color: #00000033;
            padding: 0 10px;
            font-size: 0.9em;">
            <span><b>mode: </b></span>
        </div>
        <div>
            <span class="mode-btn" id="btn-mode-network" data-mode="network">Network</span>
            <span class="mode-btn" id="btn-mode-ecosystem" data-mode="ecosystem">Ecosystem</span>
            <span class="mode-btn mode-btn-active" id="btn-mode-comparison" data-mode="comparison">Comparison</span>
        </div>

    </div>

    <div class="filter-widgets" style="
        z-index: 20000; position: fixed; top: 8vh; left: 5vw; transform: skew(-0deg); width: 35vw">
        <!--todo Optimize for small screen-->
        <div style="border-bottom: 4px solid #00000033; overflow: auto;"
             data-step="3" data-intro="Select specific ecosystem that you want to compare with">
            <div id="filter-button" onclick="filterAnimation.toggle()" class="mode-btn"
                  style="background-color: #77777785; border-right-width: 6px; margin-right: 3vw">
                <img id="filter-expand-arrow" style="height: 10px; margin-right: 8px"
                      src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTYuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgd2lkdGg9IjUxMnB4IiBoZWlnaHQ9IjUxMnB4IiB2aWV3Qm94PSIwIDAgMzA2IDMwNiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgMzA2IDMwNjsiIHhtbDpzcGFjZT0icHJlc2VydmUiPgo8Zz4KCTxnIGlkPSJleHBhbmQtbW9yZSI+CgkJPHBvbHlnb24gcG9pbnRzPSIyNzAuMyw1OC42NSAxNTMsMTc1Ljk1IDM1LjcsNTguNjUgMCw5NC4zNSAxNTMsMjQ3LjM1IDMwNiw5NC4zNSAgICIgZmlsbD0iIzAwMDAwMCIvPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo="
                      alt=""/>
                Select Ecosystems
            </div>
        </div>
        <div class="float-text--content" id="filter-content-container"
             style="max-height: 70vh; top: -3px; left: 0; background-color: #ffffffe6">
            <div uk-filter="target: .js-filter">

                <p class="uk-margin-top"> Enable the ecosystems that you want to compare. Drag to reorder.</p>
                <hr>

                <div class="uk-grid-small uk-flex-middle uk-margin-left" uk-grid>
                    <div class="uk-width-expand">
                        <div class="uk-grid-small uk-flex-middle" uk-grid>
                            <div class="uk-width-1-6">Select: </div>
                            <div>
                                <ul class="uk-subnav uk-subnav-pill" style="display: inline-flex; margin: 0">
                                    <li id="filter-btn-sel-all"><a href="#">All</a></li>
                                    <li id="filter-btn-desel-all"><a href="#">None</a></li>
                                </ul>
                            </div>
                        </div>
                        <div style="margin-top: 15px" class="uk-grid-small uk-flex-middle" uk-grid>
                            <div class="uk-width-1-6">Sort: </div>
                            <div>
                                <ul class="uk-subnav uk-subnav-pill" style="display: inline-flex; margin: 0">
                                    <li uk-filter-control="sort: data-ecosystem-name"><a href="#">By Name</a></li>
                                    <li uk-filter-control="sort: data-uploaddate; order: desc"><a href="#">Most Recent</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <p id="filter-loading" style="text-align: center">Loading...</p>

                <ul uk-sortable="handle: .uk-sortable-handle"
                    class="uk-margin-left js-filter uk-list"
                    id="filter-list-container"
                    style="overflow-x: hidden">

                    <!--<li class="filter-eco-item"-->
                        <!--data-uploaddate="2016-06-01"-->
                        <!--data-ecosystem-name="?">-->
                        <!--<span class="uk-sortable-handle uk-margin-small-right" uk-icon="icon: table"></span>-->
                        <!--<label class="uk-margin-small-right"><input class="uk-checkbox" type="checkbox"></label>-->
                        <!--<span>Ecosystem 1</span>-->
                    <!--</li>-->
                    <!--<li data-uploaddate="2016-12-13"-->
                        <!--data-ecosystem-name="?">-->
                        <!--<span class="uk-sortable-handle uk-margin-small-right" uk-icon="icon: table"></span>-->
                        <!--<label><input class="uk-checkbox" type="checkbox"></label>-->
                        <!--<span>Ecosystem 2</span>-->
                    <!--</li>-->

                </ul>

            </div>

            <button class="uk-button uk-button-primary"
                    style="float: right; margin-top: 20px"
                    id="filter-apply">
                Apply
            </button>

        </div>
    </div>


    <!--Text and note goes here-->
    <div class="float-text">
        <h2 class="float-text--header" id="content-ecosystem-name">Powers of Ten</h2>
        <div class="float-text--content" id="caption-content" >
            <h3 class="float-text--content-title">
                <span id="content-node-name">Node Name</span>
                <span class="w3-right">
                    <span style="font-weight: 200" id="content-granularity">Ã—10</span>
                    <span style="font-size: 0.9em; position: relative; top: -0.5em; left: -0.2em;" id="content-scale">5</span>
                </span>
            </h3>
            <hr style="margin: 0" />
            <p id="content-node-description">
                it is the product fossilized trees in scale 1 and  makes up the base of the ...</p>
        </div>
    </div>

    <!--Nav Arrows-->
    <div class="nav-arrow" id="arrow-right">
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"	 viewBox="0 0 41.999 41.999" style="enable-background:new 0 0 41.999 41.999;" xml:space="preserve"><path d="M36.068,20.176l-29-20C6.761-0.035,6.363-0.057,6.035,0.114C5.706,0.287,5.5,0.627,5.5,0.999v40	c0,0.372,0.206,0.713,0.535,0.886c0.146,0.076,0.306,0.114,0.465,0.114c0.199,0,0.397-0.06,0.568-0.177l29-20	c0.271-0.187,0.432-0.494,0.432-0.823S36.338,20.363,36.068,20.176z"/><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>
    </div>
    <div class="nav-arrow" id="arrow-left" style="transform: rotate(180deg);">
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"	 viewBox="0 0 41.999 41.999" style="enable-background:new 0 0 41.999 41.999;" xml:space="preserve"><path d="M36.068,20.176l-29-20C6.761-0.035,6.363-0.057,6.035,0.114C5.706,0.287,5.5,0.627,5.5,0.999v40	c0,0.372,0.206,0.713,0.535,0.886c0.146,0.076,0.306,0.114,0.465,0.114c0.199,0,0.397-0.06,0.568-0.177l29-20	c0.271-0.187,0.432-0.494,0.432-0.823S36.338,20.363,36.068,20.176z"></path><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>

    </div>
    <div class="nav-arrow" id="arrow-up" style="transform: rotate(-90deg);">
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"	 viewBox="0 0 41.999 41.999" style="enable-background:new 0 0 41.999 41.999;" xml:space="preserve"><path d="M36.068,20.176l-29-20C6.761-0.035,6.363-0.057,6.035,0.114C5.706,0.287,5.5,0.627,5.5,0.999v40	c0,0.372,0.206,0.713,0.535,0.886c0.146,0.076,0.306,0.114,0.465,0.114c0.199,0,0.397-0.06,0.568-0.177l29-20	c0.271-0.187,0.432-0.494,0.432-0.823S36.338,20.363,36.068,20.176z"/><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>

    </div>
    <div class="nav-arrow" id="arrow-down" style="transform: rotate(90deg)">
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"	 viewBox="0 0 41.999 41.999" style="enable-background:new 0 0 41.999 41.999;" xml:space="preserve"><path d="M36.068,20.176l-29-20C6.761-0.035,6.363-0.057,6.035,0.114C5.706,0.287,5.5,0.627,5.5,0.999v40	c0,0.372,0.206,0.713,0.535,0.886c0.146,0.076,0.306,0.114,0.465,0.114c0.199,0,0.397-0.06,0.568-0.177l29-20	c0.271-0.187,0.432-0.494,0.432-0.823S36.338,20.363,36.068,20.176z"/><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>

    </div>

    <div id="fade-edge" style="display: none">
        <img style="position: absolute; padding: 20px; " id="edge-left" src="res/fade-edge.png">
        <img style="position: absolute; padding: 20px;  transform: rotate(180deg); " id="edge-right" src="res/fade-edge.png">
    </div>

    <!-- Slider main container -->
    <div class="swiper-container" id="swiper-container-h" style="position: absolute">
        <!-- Additional required wrapper -->
        <div class="swiper-wrapper" style="position: fixed;">
            <!-- Slides -->

            <div class="swiper-slide swiper-slide-h"
                 id="loading-text">Loading ... </div>
        </div>

        <!-- If we need scrollbar -->
        <div class="swiper-scrollbar"></div>
    </div>


</div>


<script src="https://unpkg.com/animejs@3.0.0/lib/anime.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.2/js/uikit.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.2/js/uikit-icons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/2.9.3/intro.min.js"></script>

<script src="js/utilities.js"></script>
<script src="js/swiper.js"></script>

<script>
    const el_text_ecosystem_name = document.querySelector('#content-ecosystem-name');
    const el_text_node_name = document.querySelector('#content-node-name');
    const el_text_node_desc = document.querySelector('#content-node-description');
    const el_text_granularity = document.querySelector('#content-granularity');
    const el_text_scale = document.querySelector('#content-scale');
    function setCaption(title, subtitle, content, granularity, scale) {
        el_text_ecosystem_name.innerHTML = title || 'Ecosystem ?';
        el_text_node_name.innerHTML = subtitle || 'One Node';
        el_text_node_desc.innerHTML = content;
        switch (granularity) {
            case undefined:
            case null:
                el_text_granularity.innerHTML = 'x10';
                el_text_scale.innerHTML = '?';
                break;
            case 'linear':
                el_text_granularity.innerHTML = scale;
                el_text_scale.innerHTML = '';
                break;
            default:
                el_text_granularity.innerHTML = 'x'+granularity;
                el_text_scale.innerHTML = scale;
        }
    }
</script>

<script>

    const LSTORAGE_KEY_FILTER_SETTING = 'filter_settings';

    function loadFilterData(ecosystemData) {
        const el_filter_list_container = document.querySelector('#filter-list-container');

        // Remove the demo data filled
        while(el_filter_list_container.firstChild){
            el_filter_list_container.removeChild(el_filter_list_container.firstChild);
        }

        // ecosystemData = ecosystemData.filter(e => !e.filter.hide);

        for (var setIdx = 0; setIdx < ecosystemData.length; setIdx++) {
            const eco = ecosystemData[setIdx];
            appendDom(el_filter_list_container,
                `<li class="filter-eco-item"
                    data-uploaddate="${eco.updatetimestamp}"
                    data-ecosystem-name="${eco.name}"
                    data-ecosystem-id="${eco.id}">
                    <span class="uk-sortable-handle uk-margin-small-right" uk-icon="icon: table"></span>
                    <label class="uk-margin-small-right">
                        <input class="uk-checkbox" type="checkbox" ${eco.filter.hide?'':'checked'}>
                    </label>
                    <span>${eco.name}</span>
                </li>`
            );
        }

        // anime({
        //     targets: '.filter-eco-item',
        //     translateX: [200, 0],
        //     delay: anime.stagger(50)
        // });

    }

    function loadImgData(setPath, imageSetData) {
        var ecosysContainer = document.querySelector('div#swiper-container-h').querySelector('.swiper-wrapper');

        // Remove the demo data filled
        while(ecosysContainer.firstChild){
            ecosysContainer.removeChild(ecosysContainer.firstChild);
        }

        imageSetData = imageSetData.filter(e => !e.filter.hide);
        for (var setIdx = 0; setIdx < imageSetData.length; setIdx++) {
            var ecoInnerSlideList = '';
            for (var i=0; i<imageSetData[setIdx].nodeList.length; i++) {
                var imgPath = imageSetData[setIdx].nodeList[i];
                imgPath = 'data/ImageSecure/image.php?id=' + imgPath.fk_image_id;
                ecoInnerSlideList +=
                    `<div class="swiper-slide swiper-slide-v">
                        <div class="slide-v-container">
                            <img class="slide-img" src="${imgPath}" alt=""/>
                        </div>
                    </div>`;
            }

            const slideId = 'slide-' + setIdx;
            appendDom(ecosysContainer,
                `<div class="swiper-slide swiper-slide-h" data-hash="${slideId}">
                    <div class="ecoCover"></div>
                    <div class="label-on-ecosystem">${imageSetData[setIdx].name}</div>
                        <div class="swiper-container swiper-container-v" id="${slideId}">
                            <div class="swiper-wrapper">${ecoInnerSlideList}</div>
                        </div>
                </div>`);
        }

    }

    var ecoSlides, ecoSwiper;
    function loadSwipers(data_ecosystem) {

        if (ecoSlides) {
            for (var i = 0; i < ecoSlides.length; i++) {
                if (ecoSlides[i]) {
                    ecoSlides[i].removeAllSlides();
                }
            }
        }

        data_ecosystem = data_ecosystem.filter(e => !e.filter.hide);

        // Nodes of each ecosystems
        ecoSlides = [];
        for (var i = 0; i < data_ecosystem.length; i++) {
            const sp = new Swiper('#slide-'+i, {

                // speed: 400,

                // grabCursor: true,
                centeredSlides: true,
                initialSlide: parseInt(data_ecosystem[i].nodeList.length / 2 + (Math.random()-0.5)*6),
                // slideToClickedSlide: true,
                // Responsive breakpoints
                slidesPerView: 8,
                spaceBetween: 20,
                breakpoints: {
                    1600: {
                        slidesPerView: 6,
                        spaceBetween: 20,
                    },
                    1024: {
                        slidesPerView: 4,
                        spaceBetween: 20,
                    },
                    640: {
                        slidesPerView: 2,
                        spaceBetween: 15,
                    }
                },
                on: {
                    /*progress: function (p) {
                        allow_nav_arrow = false;
                    },*/
                    /*slideChange: function () {
                        if ( ecoSwiper !== undefined ) {

                            // Change other eco-systems' images
                            // todo Keep in the same scale
                            if (this.isActive) {

                                // left-right animation
                                anime({
                                    targets: '.swiper-slide-h:not(.swiper-slide-active)',
                                    autoplay: true,
                                    rotateX: [0, 30, 0],
                                    duration: 600,
                                    easing: 'easeOutSine',
                                    delay: function (el, i, l) {
                                        return Math.abs(i - ecoSwiper.realIndex) * 100;
                                    },
                                });

                                const _slideIncr = this.realIndex - this.previousIndex;
                                for (var i = 0; i < ecoSlides.length; i++) {
                                    if ( ecoSlides[i] === this ) continue;
                                    ecoSlides[i].slideTo(ecoSlides[i].realIndex + _slideIncr);
                                }
                            }
                        }
                    },
                    transitionEnd: function () {
                        allow_nav_arrow = true;

                        if (lastActiveSlideId === null) return;
                        /!*!// Text animation
                        anime({
                            targets: ['.float-text--header', '.float-text--content'],
                            opacity: [0, 1],
                            delay: anime.stagger(100),
                            autoplay: true
                        });*!/
                        const data_eco = data_ecosystem[ecoSwiper.realIndex];
                        const data_node = data_eco.nodeList[this.activeIndex];
                        if (data_node === undefined) return;
                        var title = data_eco.name;
                        var subtitle = data_node ? data_node.name : 'node_name';
                        var content = ''; //Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry\'s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged'.substring(Math.random()*200);
                        if (typeof(data_node) === "object") {
                            if (data_eco.description !== '') {
                                content = data_eco.description;
                            }
                        }
                        console.log('1 data_node', data_node);
                        console.log('1 this.realIndex', this.realIndex);
                        console.log('1 this.activeIndex', this.activeIndex);

                        // fixme A bug that transitionEnd() got call randomly
                        //      (due to the Change other eco-systems' images in on-SlideChange)
                        setCaption(title, subtitle, content, data_eco.granularity, data_node.scale);

                    },*/
                    /*init: function () {
                        this.allowTouchMove = false;
                        this.el.style.opacity = 1;
                    }*/

                },
            });

            ecoSlides.push(sp);
        }

        // init the swiper
        if (ecoSwiper) {
            ecoSwiper.removeAllSlides();
        }

        function getNearestScaleIndex(itemEcosystem, targetScale) {
            // Premise: itemEcosystem.nodeList is ascending.
            if (itemEcosystem.nodeList.length === 1) {
                return 0;
            }
            if (targetScale <= itemEcosystem.nodeList[0].scale)
                return 0;
            if (targetScale >= itemEcosystem.nodeList[itemEcosystem.nodeList.length-1].scale) {
                return itemEcosystem.nodeList.length-1;
            }
            for (var i = 0; i < itemEcosystem.nodeList.length - 1; i++) {
                if (itemEcosystem.nodeList[i].scale <= targetScale
                    && targetScale <= itemEcosystem.nodeList[i + 1].scale) {
                    if ( targetScale - itemEcosystem.nodeList[i].scale < itemEcosystem.nodeList[i + 1] - targetScale)
                        return i;
                    else
                        return i+1;
                }
            }
        }

        function attachTransitionEndEvent(swiper) {
            var handler = function () {
                if (!ecoSwiper) return;
                const data_eco = data_ecosystem[ecoSwiper.realIndex];
                const data_node = data_eco.nodeList[swiper.activeIndex];

                // console.log('ecoSwiper.realIndex',ecoSwiper.realIndex);
                // Iterate thru all the ecosystems, find the nearest scale and slideTo the scale
                for (var ecoIdx_=0; ecoIdx_<data_ecosystem.length; ecoIdx_++) {
                    if (ecoIdx_ === ecoSwiper.realIndex)
                        continue;
                    // console.log(ecoIdx_);
                    var idx_ = getNearestScaleIndex( data_ecosystem[ecoIdx_], data_node.scale);
                    ecoSlides[ecoIdx_].slideTo(idx_);
                }

                if (data_node === undefined) return;
                var title = data_eco.name;
                var subtitle = data_node ? data_node.name : 'node_name';
                var content = ''; //Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry\'s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged'.substring(Math.random()*200);
                if (typeof (data_node) === "object") {
                    if (data_eco.description !== '') {
                        content = data_eco.description;
                    }
                }
                setCaption(title, subtitle, content, data_eco.granularity, data_node.scale);
            };
            swiper.on('transitionEnd', handler);
        }

        var lastActiveSlideId;
        // Swiper of each ecosystem
        ecoSwiper = new Swiper('#swiper-container-h', {

            direction: 'vertical',
            /*effect: 'coverflow',
            coverflowEffect: {
                rotate: 25,
                stretch: 90,
                depth: 600,
                modifier: 1,
                slideShadows : false,
            },*/

            // speed: 400,
            initialSlide: 1,
            centeredSlides: true,
            // slideToClickedSlide: true, //click on any slide will produce transition to this slide
            keyboard: {
                enabled: true,
            },
            mousewheel: {
                invert: false,
                releaseOnEdges: true
            },
            hashNavigation: {
                watchState: true,
            },
            /*scrollbar: {
                el: '.swiper-scrollbar',
                draggable: true,
            },*/
            // Responsive breakpoints
            slidesPerView: 5,
            spaceBetween: 15,
            breakpoints: {
                1024: {
                    slidesPerView: 5,
                    spaceBetween: 10,
                },
                640: {
                    slidesPerView: 5,
                    spaceBetween: 5,
                }
            },
            on: {
                /*progress: function (progress) {
                    console.log('on "progress":' + progress);
                    if (this.canPlayLRAnim === true) {
                        if (lastActiveSlideId === null) {return}
                        const swiper = this;
                        // left-right animation -- collapse
                        anime({
                            targets: '.swiper-slide-h',
                            autoplay: true,
                            translateX: 0,
                            scale: 1,
                            duration: 100,
                            easing: 'easeInOutSine',
                            delay: function(el, i, l) {
                                return Math.abs(i-swiper.realIndex) * 100;
                            },
                        });
                        // hide the arrows
                        allow_nav_arrow = false;
                        this.canPlayLRAnim = false;
                        fadeEdge.anim_hide();
                    }
                },
                transitionEnd: function() {
                    console.log('on transitionEnd: realIndex=' + this.realIndex + ' lastActiveSlideId='+lastActiveSlideId);

                    fadeEdge.anim_show();

                    if (lastActiveSlideId === null) {return}

                    allow_nav_arrow = true;
                    this.canPlayLRAnim = true;

                    // left-right animation -- expand
                    // anim_lr_expend(this);

                    if (lastActiveSlideId !== this.realIndex) {
                        // actually move changed slides

                        // Deactivate the current (previous) ecosys
                        ecoSlides[lastActiveSlideId].allowTouchMove = false;
                        ecoSlides[lastActiveSlideId].anim.collapse();
                        ecoSlides[lastActiveSlideId].isActive = false;

                        // Activate the current
                        ecoSlides[this.realIndex].allowTouchMove = true;
                        ecoSlides[this.realIndex].anim.expand();
                        ecoSlides[this.realIndex].isActive = true;

                        // Text animation
                        floatTextAnimation.show();

                        const data_eco = data_ecosystem[this.realIndex];
                        const data_node = data_eco.nodeList[ecoSlides[this.realIndex].realIndex];
                        var title = data_eco.name;
                        var subtitle = data_node ? data_node.name : 'node_name';
                        var content = ''; //Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry\'s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged';
                        if (typeof(data_node) === "object") {
                            if (data_eco.description !== '') {
                                content = data_eco.description;
                            }
                        }

                        // if (data_node === undefined) {
                        //     console.log('data_eco', data_eco);
                        //     console.log('lastActiveSlideId', lastActiveSlideId);
                        //     console.log('this.realIndex', this.realIndex);
                        // }

                        // console.log('2data_node', data_node);
                        setCaption(title, subtitle, content, data_eco.granularity, data_node.scale);
                    }

                    lastActiveSlideId = this.realIndex;
                },
                init: function() {
                    // this.coverflowEffect.transitToTranslate(0);


                }*/
                transitionEnd: function() {
                    if (lastActiveSlideId !== this.realIndex) {
                        // make sure that it actually moved

                        // Text animation
                        floatTextAnimation.show();

                        const data_eco = data_ecosystem[this.realIndex];
                        const data_node = data_eco.nodeList[ecoSlides[this.realIndex].realIndex];
                        var title = data_eco.name;
                        var subtitle = data_node ? data_node.name : 'node_name';
                        var content = ''; //Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry\'s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged';
                        if (typeof(data_node) === "object") {
                            if (data_eco.description !== '') {
                                content = data_eco.description;
                            }
                        }
                        setCaption(title, subtitle, content, data_eco.granularity, data_node.scale);

                        if (lastActiveSlideId !== undefined)
                            ecoSlides[lastActiveSlideId].off('transitionEnd');
                        attachTransitionEndEvent(ecoSlides[this.realIndex]);
                    }
                    lastActiveSlideId = this.realIndex;
                }
            }
        });
    }

    var data_ecosystem;
    var filter_persistence;

    document.querySelector('button#filter-apply').addEventListener('click', function () {

        filter_persistence = {
            order: [],
            hidden: []
        };

        const items = document.querySelectorAll('li.filter-eco-item');
        for (var i = 0; i < items.length; i++) {
            const _id = String(items[i].dataset.ecosystemId);
            filter_persistence.order.push(_id);
            if ( ! items[i].querySelector('input').checked) {
                filter_persistence.hidden.push(_id);
            }
        }

        window.localStorage.setItem(LSTORAGE_KEY_FILTER_SETTING, JSON.stringify(filter_persistence));
        window.location.reload();
    });

    function set_all_filter_check_status(status) {
        const items = document.querySelectorAll('li.filter-eco-item');
        for (var i = 0; i < items.length; i++) {
            items[i].querySelector('input').checked = status;
        }
    }

    document.querySelector('#filter-btn-sel-all').addEventListener('click', function (el) {
        set_all_filter_check_status(true);
    });
    document.querySelector('#filter-btn-desel-all').addEventListener('click', function (el) {
        set_all_filter_check_status(false);
    });

    var filterAnimation = {
        el_header: document.querySelector('.filter-widgets'),
        el_arrow: document.querySelector('#filter-expand-arrow'),
        el_content: document.querySelector('#filter-content-container'),
        el_button: document.querySelector('#filter-button'),
        state: 'expanded',
        expand: function () {
            anime.timeline({
                autoplay: true,
                duration: 550
            }).add({
                targets: this.el_header,
                width: ['18vw', '35vw'],
                skew: [-10, 0]
            }).add({
                targets: this.el_arrow,
                rotateZ: [0, 90],
                duration: 500
            }, '-=200').add({
                targets: this.el_content,
                opacity: [0, 1],
                scaleY: [0.5, 1],
                translateY: ['-30%', 0],
                easing: 'easeOutQuart'
            }, '-=600');
            this.state = 'expanded';
        },
        collapse: function () {
            anime.timeline({
                autoplay: true,
                duration: 550
            }).add({
                targets: this.el_arrow,
                rotateZ: [90, 0],
                duration: 500
            }).add({
                targets: this.el_content,
                opacity: [1, 0],
                duration: 600
            }, '-=400').add({
                targets: this.el_header,
                width: ['35vw', '18vw'],
                skew: [0, -10],
                easing: 'easeOutQuart'
            }, '-=350');
            this.state = 'collapsed';
        },
        toggle: function () {
            if (this.state === 'collapsed') {
                this.expand();
            } else {
                this.collapse();
            }
        }
    };

    const el_fText = document.querySelector('.float-text');
    const el_dotBg = document.querySelector('div.dot-bg');

    var floatTextAnimation = {
        targets: ['.float-text--header', '#caption-content'],
        show: function () {
            anime({
                targets: this.targets,
                translateX: [-100, 0],
                opacity: [0, 1],
                delay: anime.stagger(100),
                autoplay: true
            });
        },
        hide: function () {
            anime({
                targets: this.targets,
                translateX: -100,
                opacity: 0,
                delay: anime.stagger(100),
                autoplay: true
            });
        }
    };

    const fadeEdge = {
        el_left: document.querySelector('#edge-left'),
        el_right: document.querySelector('#edge-right'),
        el_container: document.querySelector('#fade-edge'),
        _lock_show: false,
        _lock_hide: false,
        anim_hide: function () {
            if (this.reposition() === false) return;

            if (this._lock_hide) {
                return;
            }
            this._lock_hide = true;

            const self = this;
            anime({
                targets: this.el_container,
                opacity: 0,
                complete: function () {
                    self._lock_hide = false;
                }
            })
        },
        anim_show: function () {
            if (this.reposition() === false) return;

            if (this._lock_show) {
                return;
            }
            this._lock_show = true;

            const self = this;
            anime({
                targets: this. el_container,
                opacity: 1,

                complete: function () {
                    self._lock_show = false;
                }
            })
        },
        reposition: function () {
            this.el_container.style.display = 'block';

            const activeSlide = document.querySelector('' +
                '.swiper-slide-h.swiper-slide-active ' +
                '.swiper-slide-v.swiper-slide-active ' +
                '.slide-img');

            if (activeSlide === null) {
                return false;
            }

            var bRect = activeSlide.getBoundingClientRect();

            var width = this.el_left.getBoundingClientRect().width;
            this.el_left.style.left = `${bRect.left - width}px`;
            this.el_right.style.left = `${bRect.left + bRect.width}px`;

            return true;
        }

    };


    const arrowAct = {
        state: 'hidden',  //hidden, shown, animating
        el: {
            up   : document.querySelector('#arrow-up'),
            down : document.querySelector('#arrow-down'),
            left : document.querySelector('#arrow-left'),
            right: document.querySelector('#arrow-right'),
        },
        width: document.querySelector('.nav-arrow').getBoundingClientRect().width,
        height: document.querySelector('.nav-arrow').getBoundingClientRect().height,
        hide: function () {
            // this.el.up   .style.display = 'none';
            // this.el.down .style.display = 'none';
            // this.el.left .style.display = 'none';
            // this.el.right.style.display = 'none';
            if (this.state !== 'hidden') {
                this.anim.out();
            }
        },
        show: function (el) {
            // this.el.up   .style.display = 'block';
            // this.el.down .style.display = 'block';
            // this.el.left .style.display = 'block';
            // this.el.right.style.display = 'block';
            if (el) {
                // re-position the arrows
                const rct = el.getBoundingClientRect();
                this.el.up   .style.left = px_(rct.left + rct.width / 2 - this.width  /2);
                this.el.up   .style.top = px_(rct.top                   - this.height /2);
                this.el.down .style.left = px_(rct.left + rct.width / 2 - this.width  /2);
                this.el.down .style.top = px_(rct.bottom                - this.height /2);
                this.el.left .style.left = px_(rct.left                 - this.width  /2);
                this.el.left .style.top = px_(rct.top + rct.height / 2  - this.height /2);
                this.el.right.style.left = px_(rct.right                - this.width  /2);
                this.el.right.style.top = px_(rct.top + rct.height / 2  - this.height /2);
            }
            if (this.state !== 'shown') {
                this.anim.in();
            }
        },
        anim: {
            in: function () {
                arrowActAnim.restart();
            },
            out: function () {
                arrowActAnim.seek(arrowActAnim.duration - 1);
                arrowActAnim.reverse();
                arrowActAnim.play();
            }
        }
    };
    const arrowActAnim = anime({
        targets: [arrowAct.el.up, arrowAct.el.down, arrowAct.el.left, arrowAct.el.right],
        translateX: [20, 0],  // Since we've already rotated them, we can simple translate by X.
        opacity: [0, 1],
        duration: 400,
        easing: 'easeInBack',
        autoplay: false,
        update: function (anim) {
            // State machine
            if (anim.progress === 0) arrowAct.state = 'hidden';
            else if (anim.progress === 1) arrowAct.state = 'shown';
            else arrowAct.state = 'animating';
        }
    });
    arrowAct.hide();

    var allow_nav_arrow = true;

    var lastMouseOverElement = null;
    window.addEventListener('mousemove', function(evt) {
        const halfH = document.documentElement.clientHeight /2;
        const halfW = document.documentElement.clientWidth /2;

        var pdx = 1 - evt.clientX / halfW;
        var pdy = 1 - evt.clientY / halfH;

        // console.log( evt.clientX + "," + evt.clientY
        //     + " | " + dx + "," + dy
        //     + " | " + pdx + "," + pdy);

        el_dotBg.style.transform =
            // ' rotateX('+pdx*10+'deg) rotateY('+pdy*10+'deg)' +
            ' skew('+-pdy*5+'deg,'+-pdx*5+'deg)' +
            ' translateX('+pdx*5+'px) translateY('+pdy*5+'px)';

        // Dynamic effects on the text
        const sz = el_fText.getBoundingClientRect();
        pdx = (sz.x + sz.width / 2 - event.clientX) / document.documentElement.clientWidth;
        pdy = (sz.y + sz.height / 2 - event.clientY) / document.documentElement.clientHeight;
        el_fText.style.transform =
            ' rotateX('+pdy*15+'deg) rotateY('+pdx*15+'deg)' +
            ' skew(-10deg)';

        // Nav-arrows monitor
        const activeSlide = document.querySelector('' +
            '.swiper-slide-h.swiper-slide-active ' +
            '.swiper-slide-v.swiper-slide-active ' +
            '.slide-img');
        const elementMouseIsOver = document.elementFromPoint(evt.clientX, evt.clientY);
        if (elementMouseIsOver !== lastMouseOverElement) {

            if (lastMouseOverElement === activeSlide) {
                // console.log('move outside');
                document.body.style.cursor = null;
                arrowAct.hide();
            }
            if (allow_nav_arrow && elementMouseIsOver === activeSlide) {
                // console.log('inside');
                document.body.style.cursor = 'pointer';
                arrowAct.show(activeSlide);
            }

            lastMouseOverElement = elementMouseIsOver;
        }

    });

    // Monitor the keyboard input (for navigating up&down)
    window.addEventListener("keydown", function(event) {

        if (event.key === 'ArrowLeft') {
            if (ecoSlides[ecoSwiper.realIndex]) {
                ecoSlides[ecoSwiper.realIndex].slidePrev();
            }
        } else if (event.key === 'ArrowRight') {
            if (ecoSlides[ecoSwiper.realIndex]) {
                ecoSlides[ecoSwiper.realIndex].slideNext();
            }
        }

    }, true);

    window.addEventListener('click', function (evt) {
        // Nav-arrows monitor
        const activeSlide = document.querySelector('' +
            '.swiper-slide-h.swiper-slide-active ' +
            '.swiper-slide-v.swiper-slide-active ' +
            '.slide-img');
        if (activeSlide === document.elementFromPoint(evt.clientX, evt.clientY)) {
            console.log('clicked on active slide');

            // Activate ecosystem mode

            anime({
                targets: '.swiper-slide-h.swiper-slide:not(.swiper-slide-active)',
                rotate: anime.stagger([-360, 360]),
                opacity: 0,
                duration: 2000,
                autoplay: true
            });
            anime({
                targets: '.swiper-slide-v.swiper-slide:not(.swiper-slide-active)',
                translateY: anime.stagger(30, {easing: 'easeOutQuad'}),
                duration: 2000,
                autoplay: true
            });
            anime({
                targets: el_dotBg,
                rotate: [-360, 235],
                scale: [1, 5],
                duration: 1000,
                autoplay: true,
                complete: function (anim) {
                    const nodeId = data_ecosystem[ecoSwiper.realIndex].nodeList[ecoSlides[ecoSwiper.realIndex].realIndex].id;
                    const ecoId = data_ecosystem[ecoSwiper.realIndex].id;
                    window.location.href = `ecosystem.html?ecosystem=${ecoId}#${nodeId}`;
                }
            });
            anime({
                targets: document.body,
                opacity: 0,
                duration: 3000
            })

        }
    });

    // mode switch
    function modeBtnListener(evt) {
        const nodeId = data_ecosystem[ecoSwiper.realIndex]
            .nodeList[ecoSlides[ecoSwiper.realIndex].realIndex].id;
        const ecoId = data_ecosystem[ecoSwiper.realIndex].id;
        switch (evt.target.dataset.mode) {
            case 'network':
                window.location.href = 'network.html?ecosystem=' + ecoId;
                break;
            case 'ecosystem':
                window.location.href = `ecosystem.html?ecosystem=${ecoId}#${nodeId}`;
                break;
            case 'comparison':
                window.location.href = 'comparison.html?ecosystem=' + ecoId;
                break;
        }
    }
    document.querySelector('#btn-mode-network').addEventListener('click', modeBtnListener);
    // document.querySelector('#btn-mode-comparison').addEventListener('click', modeBtnListener);
    document.querySelector('#btn-mode-ecosystem').addEventListener('click', modeBtnListener);

    lastActiveSlideId = null;

    var eco_id_dict = {};
    var filter_storage_string = window.localStorage.getItem(LSTORAGE_KEY_FILTER_SETTING);
    if (filter_storage_string === '' || filter_storage_string === null) {
        filter_persistence = {
            order: [],
            hidden: []
        };
    } else {
        filter_persistence = JSON.parse(filter_storage_string);
    }

    // Fetch the ecosystem data, and read filtered ecosystems from localStorage
    data_ecosystem_pre = JSON.parse(ajax('GET', 'data/api.php/records/ecosystem', null, false)).records;
    if (data_ecosystem_pre !== undefined) {

        for (var i = 0; i < data_ecosystem_pre.length; i++) {
            const eco_id = String(data_ecosystem_pre[i].id);

            // Fetch every image node
            data_ecosystem_pre[i].nodeList = JSON.parse(ajax('GET',
                'data/api.php/records/node?filter=fk_ecosystem_id,eq,' + eco_id, null, false)).records;

            for (var j in data_ecosystem_pre[i].nodeList) {
                data_ecosystem_pre[i].nodeList[j].scale = parseInt(data_ecosystem_pre[i].nodeList[j].scale);
            }

            // Sort the ecosystem nodes first
            data_ecosystem_pre[i].nodeList.sort((node1, node2) => {
                if (node1.scale === null || node2.scale === null) {
                    return 0;
                }
                return parseInt(node1.scale) - parseInt(node2.scale);
            });

            // construct the ecosystem id-hashmap
            eco_id_dict[eco_id] = data_ecosystem_pre[i];

            // load filter state from the localStorage
            if (filter_persistence.hidden.indexOf(eco_id) >= 0) {
                // hide this node
                data_ecosystem_pre[i].filter = {'hide': true}
            } else {
                data_ecosystem_pre[i].filter = {'hide': false};
                if (filter_persistence.order.indexOf(eco_id) < 0) {
                    // this is a new ecosystem, append it to the 'order' list to show it by default
                    filter_persistence.order.push(eco_id);
                }
            }

        }

        if (filter_persistence.order.length === 0) {
            data_ecosystem = data_ecosystem_pre;
        } else {
            // re-order the ecosystem according to the 'order' array
            data_ecosystem = [];
            for (i = 0; i < filter_persistence.order.length; i++) {
                var eco_id = String(filter_persistence.order[i]);
                if (eco_id_dict[eco_id]) {
                    // make sure that it actually exists
                    //      e.g. the case that an ecosystem has been deleted
                    data_ecosystem.push(eco_id_dict[eco_id]);
                }
            }
        }
    }


    // Hide the loading state
    document.querySelector('#filter-loading').style.display = 'None';

    if (data_ecosystem_pre === undefined) {
        document.querySelector('#loading-text').innerHTML =
            "Internal error, please contact the administrator.";
    } else if (data_ecosystem.length === 0) {
        document.querySelector('#loading-text').innerHTML =
            "There's no ecosystem available yet! Try to &ensp;<span><a href='upload.html'>  UPLOAD  </a></span>&ensp; one!";
    } else {
        loadFilterData(data_ecosystem);
        loadImgData('res/image_set', data_ecosystem);
        loadSwipers(data_ecosystem);

        document.querySelector('#btn-start-guide').addEventListener('click', function () {
            introJs().addStep({
                intro: 'Swipe up and down to navigate within an ecosystem'
            }).addStep({
                intro: 'or swipe left and right to navigate across ecosystems'
            }).setOption('highlightClass', 'highlightClass')
                .oncomplete(()=>{
                    setTimeout(() => {
                        introJs('body').setOption('highlightClass', 'highlightClass').start()
                    }, 20);
                }).start();
        });
    }

    // Auto hide the filter panel
    setTimeout(()=>{
        filterAnimation.collapse();
    }, 1000);


</script>

<style>
    .highlightClass {
        background-color: rgba(255,255,255,.5)
    }
</style>

</body>
</html>
