<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Upload</title>

    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.2/css/uikit.min.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="css/main.css">
    <style type="text/css">
        #upload-pane {
            background-color: #f0f8ff78;
            transition: background-color 1s;
        }
        #upload-pane:hover {
            background-color: #f0f8ff;
        }
    </style>

</head>
<body>

<!-- Navbar (sit on top) -->
<div class="w3-top" style="z-index: 10000">
    <div class="w3-bar w3-white w3-wide w3-padding w3-card">
        <a href="/comparison.html" class="w3-bar-item w3-button"><b></b> Speculative Explorer </a>
        <!-- Float links to the right. Hide them on small screens -->
        <div class="w3-right w3-hide-small">
            <a href="#about" class="w3-bar-item w3-button">About</a>
        </div>
        <a href="#" id="btn-upload" class="w3-bar-item w3-right w3-button w3-blue">Upload!</a>
    </div>
</div>


<div>

    <div class='dot-bg'></div>

    <div class="uk-container uk-container-small" style="margin-top: 10vh">

        <div class="uk-card uk-card-body uk-margin-small" style="text-align: center">
            <h3 class="uk-card-title">
                Upload a New EcoSystem
            </h3>
        </div>

        <div id="set-meta-card" class="uk-card uk-card-default uk-card-body">

            <div class="uk-card-header">
                <h3 class="uk-card-title">
                    <span uk-icon="icon: album"></span>
                    Set Meta
                </h3>
            </div>

            <div class="uk-card-body">
                <form class="uk-form-horizontal uk-margin-medium">

                    <div class="uk-margin">
                        <label class="uk-form-label" for="form-set-name">Name</label>
                        <div class="uk-form-controls">
                            <input class="uk-input uk-form-large" id="form-set-name" type="text" placeholder="Enter set name...">
                        </div>
                    </div>

                    <div class="uk-margin">
                        <label class="uk-form-label" for="form-scale-type">Scale Type</label>
                        <div class="uk-form-controls">
                            <select class="uk-select" id="form-scale-type">
                                <option data-val="space">Space (meters)</option>
                                <option data-val="time">Time (seconds)</option>
                                <option data-val="intensity">Intensity (percentage)</option>
                                <option data-val="generic">Generic (digits)</option>
                            </select>
                        </div>
                    </div>

                    <div class="uk-margin">
                        <div class="uk-form-label">Granularity</div>
                        <div class="uk-form-controls uk-form-controls-text">
                            <label><input class="form-granularity-option uk-radio" type="radio" name="granularity-p10" data-val="10"> Powers of 10</label>
                            <label><input class="form-granularity-option uk-radio uk-margin-left" type="radio" name="granularity-p2" data-val="2"> Powers of 2</label>
                            <label><input class="form-granularity-option uk-radio uk-margin-left" type="radio" name="granularity-l" data-val="linear"> Linear</label>
                        </div>
                    </div>

                    <div class="uk-margin">
                        <label class="uk-form-label" for="form-set-desc">Description</label>
                        <div class="uk-form-controls">
                            <textarea class="uk-textarea" id="form-set-desc" rows="5" placeholder="Set description. Tell people about this set"></textarea>
                        </div>
                    </div>

                </form>
            </div>

        </div>

        <hr class="uk-divider-icon">

        <ul id="image-node-container" class="uk-grid-small uk-child-width-1-1 uk-text-left" uk-sortable="handle: .uk-sortable-handle" uk-grid>
<!--
            <li>
                <div class="uk-card uk-card-hover uk-card-default uk-card-body">

                    <div class="uk-child-width-expand@s" uk-grid>
                        <div class="uk-grid-item-match uk-grid-small">

                            &lt;!&ndash;column 1/3&ndash;&gt;
                            <div class="uk-width-auto uk-text-middle">
                                <a class="uk-margin-top uk-sortable-handle uk-margin-small-right" uk-icon="icon: table"></a>
                            </div>

                            &lt;!&ndash;column 2/3&ndash;&gt;
                            <div class="uk-width-expand">
                                <article class="uk-comment">
                                    <header class="uk-comment-header uk-grid-medium uk-flex-middle" uk-grid>
                                        <div class="uk-width-auto">
                                            <img class="uk-comment-avatar" src="res/image_set/Powers of Ten/images/7.jpg" width="80" height="80" alt="">
                                        </div>
                                        <div class="uk-width-expand">
                                            <input class="uk-comment-title uk-input uk-form-blank uk-padding-remove-left"
                                                   type="text" placeholder="Node Title">
                                            &lt;!&ndash;<h4 class="uk-comment-title uk-margin-remove"><a class="uk-link-reset" href="#">Author</a></h4>&ndash;&gt;
                                            <ul class="uk-comment-meta uk-subnav uk-subnav-divider uk-margin-remove-top">
                                                <li>640 x 480</li>
                                                <li>1,205 KB</li>
                                            </ul>
                                        </div>
                                    </header>
                                    <div class="uk-comment-body">

                                        <div class="uk-grid uk-child-width-expand@m">
                                            <div>
                                                <div class="uk-inline" style="display: unset">
                                                    <span class="uk-form-icon uk-form-icon-flip">%</span>
                                                    <input class="uk-input uk-form-small" placeholder="Scale">
                                                </div>
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small uk-magin-right" placeholder="Node ID">
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small" placeholder="Type" value="Fiction">
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small uk-magin-right" placeholder="Source" value="Text">
                                            </div>
                                            <div>
                                                <label class="uk-text-right">
                                                    <input class="uk-checkbox uk-margin-small-right" type="checkbox" checked>
                                                    Dynamic
                                                </label>
                                            </div>
                                        </div>

                                        <p><input class="uk-input uk-form-small uk-magin-right"
                                                  placeholder="Connection node to this image, enter node-id, seperated by comma. e.g. 21,23,25"></p>

                                        <p><textarea class="uk-textarea uk-form-blank" rows="5" style="border-left: dashed 1px #e5e5e5;"
                                                      placeholder="Write Description, and tell people about this image"></textarea></p>
                                    </div>
                                </article>
                            </div>

                            &lt;!&ndash;column 3/3&ndash;&gt;
                            <div class="uk-width-auto">
                                <a href="" uk-icon="icon: trash" class="uk-align-right uk-margin-top" ></a>
                            </div>

                        </div>
                    </div>

                </div>
            </li>

            <li>
                <div class="uk-card uk-card-hover uk-card-default uk-card-body">

                    <div class="uk-child-width-expand@s" uk-grid>
                        <div class="uk-grid-item-match uk-grid-small">

                            &lt;!&ndash;column 1/3&ndash;&gt;
                            <div class="uk-width-auto uk-text-middle">
                                <a class="uk-margin-top uk-sortable-handle uk-margin-small-right" uk-icon="icon: table"></a>
                            </div>

                            &lt;!&ndash;column 2/3&ndash;&gt;
                            <div class="uk-width-expand">
                                <article class="uk-comment">
                                    <header class="uk-comment-header uk-grid-medium uk-flex-middle" uk-grid>
                                        <div class="uk-width-auto">
                                            <img class="uk-comment-avatar" src="res/image_set/Powers of Ten/images/8.jpg" width="80" height="80" alt="">
                                        </div>
                                        <div class="uk-width-expand">
                                            <input class="uk-comment-title uk-input uk-form-blank uk-padding-remove-left"
                                                   type="text" placeholder="Node Title">
                                            &lt;!&ndash;<h4 class="uk-comment-title uk-margin-remove"><a class="uk-link-reset" href="#">Author</a></h4>&ndash;&gt;
                                            <ul class="uk-comment-meta uk-subnav uk-subnav-divider uk-margin-remove-top">
                                                <li>640 x 480</li>
                                                <li>1,205 KB</li>
                                            </ul>
                                        </div>
                                    </header>
                                    <div class="uk-comment-body">

                                        <div class="uk-grid uk-child-width-expand@m">
                                            <div>
                                                <div class="uk-inline" style="display: unset">
                                                    <span class="uk-form-icon uk-form-icon-flip">%</span>
                                                    <input class="uk-input uk-form-small" placeholder="Scale">
                                                </div>
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small uk-magin-right" placeholder="Node ID">
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small" placeholder="Type" value="Fiction">
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small uk-magin-right" placeholder="Source" value="Text">
                                            </div>
                                            <div>
                                                <label class="uk-text-right">
                                                    <input class="uk-checkbox uk-margin-small-right" type="checkbox" checked>
                                                    Dynamic
                                                </label>
                                            </div>
                                        </div>

                                        <p><input class="uk-input uk-form-small uk-magin-right"
                                                  placeholder="Connection node to this image, enter node-id, seperated by comma. e.g. 21,23,25"></p>

                                        <p><textarea class="uk-textarea uk-form-blank" rows="5" style="border-left: dashed 1px #e5e5e5;"
                                                     placeholder="Write Description, and tell people about this image"></textarea></p>
                                    </div>
                                </article>
                            </div>

                            &lt;!&ndash;column 3/3&ndash;&gt;
                            <div class="uk-width-auto">
                                <a href="" uk-icon="icon: trash" class="uk-align-right uk-margin-top" ></a>
                            </div>

                        </div>
                    </div>

                </div>
            </li>

            <li>
                <div class="uk-card uk-card-hover uk-card-default uk-card-body">

                    <div class="uk-child-width-expand@s" uk-grid>
                        <div class="uk-grid-item-match uk-grid-small">

                            &lt;!&ndash;column 1/3&ndash;&gt;
                            <div class="uk-width-auto uk-text-middle">
                                <a class="uk-margin-top uk-sortable-handle uk-margin-small-right" uk-icon="icon: table"></a>
                            </div>

                            &lt;!&ndash;column 2/3&ndash;&gt;
                            <div class="uk-width-expand">
                                <article class="uk-comment">
                                    <header class="uk-comment-header uk-grid-medium uk-flex-middle" uk-grid>
                                        <div class="uk-width-auto">
                                            <img class="uk-comment-avatar" src="res/image_set/Powers of Ten/images/4.jpg" width="80" height="80" alt="">
                                        </div>
                                        <div class="uk-width-expand">
                                            <input class="uk-comment-title uk-input uk-form-blank uk-padding-remove-left"
                                                   type="text" placeholder="Node Title">
                                            &lt;!&ndash;<h4 class="uk-comment-title uk-margin-remove"><a class="uk-link-reset" href="#">Author</a></h4>&ndash;&gt;
                                            <ul class="uk-comment-meta uk-subnav uk-subnav-divider uk-margin-remove-top">
                                                <li>640 x 480</li>
                                                <li>1,205 KB</li>
                                            </ul>
                                        </div>
                                    </header>
                                    <div class="uk-comment-body">

                                        <div class="uk-grid uk-child-width-expand@m">
                                            <div>
                                                <div class="uk-inline" style="display: unset">
                                                    <span class="uk-form-icon uk-form-icon-flip">%</span>
                                                    <input class="uk-input uk-form-small" placeholder="Scale">
                                                </div>
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small uk-magin-right" placeholder="Node ID">
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small" placeholder="Type" value="Fiction">
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small uk-magin-right" placeholder="Source" value="Text">
                                            </div>
                                            <div>
                                                <label class="uk-text-right">
                                                    <input class="uk-checkbox uk-margin-small-right" type="checkbox" checked>
                                                    Dynamic
                                                </label>
                                            </div>
                                        </div>

                                        <p><input class="uk-input uk-form-small uk-magin-right"
                                                  placeholder="Connection node to this image, enter node-id, seperated by comma. e.g. 21,23,25"></p>

                                        <p><textarea class="uk-textarea uk-form-blank" rows="5" style="border-left: dashed 1px #e5e5e5;"
                                                     placeholder="Write Description, and tell people about this image"></textarea></p>
                                    </div>
                                </article>
                            </div>

                            &lt;!&ndash;column 3/3&ndash;&gt;
                            <div class="uk-width-auto">
                                <a href="" uk-icon="icon: trash" class="uk-align-right uk-margin-top" ></a>
                            </div>

                        </div>
                    </div>

                </div>
            </li>

            <li>
                <div class="uk-card uk-card-hover uk-card-default uk-card-body">

                    <div class="uk-child-width-expand@s" uk-grid>
                        <div class="uk-grid-item-match uk-grid-small">

                            &lt;!&ndash;column 1/3&ndash;&gt;
                            <div class="uk-width-auto uk-text-middle">
                                <a class="uk-margin-top uk-sortable-handle uk-margin-small-right" uk-icon="icon: table"></a>
                            </div>

                            &lt;!&ndash;column 2/3&ndash;&gt;
                            <div class="uk-width-expand">
                                <article class="uk-comment">
                                    <header class="uk-comment-header uk-grid-medium uk-flex-middle" uk-grid>
                                        <div class="uk-width-auto">
                                            <img class="uk-comment-avatar" src="res/image_set/Powers of Ten/images/10.jpg" width="80" height="80" alt="">
                                        </div>
                                        <div class="uk-width-expand">
                                            <input class="uk-comment-title uk-input uk-form-blank uk-padding-remove-left"
                                                   type="text" placeholder="Node Title">
                                            &lt;!&ndash;<h4 class="uk-comment-title uk-margin-remove"><a class="uk-link-reset" href="#">Author</a></h4>&ndash;&gt;
                                            <ul class="uk-comment-meta uk-subnav uk-subnav-divider uk-margin-remove-top">
                                                <li>640 x 480</li>
                                                <li>1,205 KB</li>
                                            </ul>
                                        </div>
                                    </header>
                                    <div class="uk-comment-body">

                                        <div class="uk-grid uk-child-width-expand@m">
                                            <div>
                                                <div class="uk-inline" style="display: unset">
                                                    <span class="uk-form-icon uk-form-icon-flip">%</span>
                                                    <input class="uk-input uk-form-small" placeholder="Scale">
                                                </div>
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small uk-magin-right" placeholder="Node ID">
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small" placeholder="Type" value="Fiction">
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small uk-magin-right" placeholder="Source" value="Text">
                                            </div>
                                            <div>
                                                <label class="uk-text-right">
                                                    <input class="uk-checkbox uk-margin-small-right" type="checkbox" checked>
                                                    Dynamic
                                                </label>
                                            </div>
                                        </div>

                                        <p><input class="uk-input uk-form-small uk-magin-right"
                                                  placeholder="Connection node to this image, enter node-id, seperated by comma. e.g. 21,23,25"></p>

                                        <p><textarea class="uk-textarea uk-form-blank" rows="5" style="border-left: dashed 1px #e5e5e5;"
                                                     placeholder="Write Description, and tell people about this image"></textarea></p>
                                    </div>
                                </article>
                            </div>

                            &lt;!&ndash;column 3/3&ndash;&gt;
                            <div class="uk-width-auto">
                                <a href="" uk-icon="icon: trash" class="uk-align-right uk-margin-top" ></a>
                            </div>

                        </div>
                    </div>

                </div>
            </li>

-->

        </ul>

        <ul class="uk-grid-small uk-child-width-1-1 uk-text-left uk-margin-medium" uk-grid>
            <li>

                <div id="upload-pane" class="js-upload uk-placeholder uk-text-center" >
                    <span uk-icon="icon: cloud-upload"></span>
                    <span class="uk-text-middle">Attach one or more images by dropping them here or</span>
                    <div uk-form-custom>
                        <input type="file" name="image[]" multiple>
                        <span class="uk-link">selecting one</span>
                    </div>
                </div>

                <progress id="js-progressbar" class="uk-progress" value="0" max="100" hidden></progress>

            </li>
            <li style="margin-bottom: 25vh">

            </li>
        </ul>


    </div>

</div>

<!-- UIkit JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.2/js/uikit.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.2/js/uikit-icons.min.js"></script>
<script src="https://unpkg.com/animejs@3.0.0/lib/anime.min.js"></script>
<script src="js/utilities.js"></script>

<script>
    const el_image_node_container = document.querySelector('#image-node-container');
</script>
<script>

    function trim(s) {
        return s.replace(/^\s+|\s+$/g, '');
    }

    function fileSizeHuman(s) {
        if (s < 1024) {
            return Math.round(s) + ' B';
        } else if (s < 1024 * 1024) {
            return Math.round(s/1024) + ' KB';
        } else {
            return Math.round(s/1024/1024) + ' MB';
        }
    }

    function removeNode(sel) {
        const el = document.querySelector(sel);
        anime({
            targets: el,
            translateX: [0, -400],
            opacity: {
                value: 0,
                duration: 200
            },
            duration: 400,
            complete: function (_) {
                el.parentNode.removeChild(el);
            }
        });
    }

    function addImageNode(imageUrl, resolution, imageSize, imageId) {
        const uid = el_image_node_container.childElementCount + 1;
        var newNode = document.createElement('li');
        newNode.setAttribute('id', 'node-'+uid);

        newNode.innerHTML = `<!--<li id="node-${uid}">-->
            <div class="uk-card uk-card-hover uk-card-default uk-card-body">
            <div class="uk-child-width-expand@s" uk-grid>
                <div class="uk-grid-item-match uk-grid-small">

                    <div class="uk-width-auto uk-text-middle">
                        <a class="uk-margin-top uk-sortable-handle uk-margin-small-right" uk-icon="icon: table"></a>
                    </div>

                    <div class="uk-width-expand">
                        <article class="uk-comment">
                            <header class="uk-comment-header uk-grid-medium uk-flex-middle" uk-grid>
                                <div class="uk-width-auto">
                                    <img id="uploadImage" class="uk-comment-avatar" src="${imageUrl}" width="80" height="80" alt="" data-image-id="${imageId}">
                                </div>
                                <div class="uk-width-expand">
                                    <input id="nodeTitle" class="uk-comment-title uk-input uk-form-blank uk-padding-remove-left"
                                           type="text" placeholder="Node Title">
                                    <ul class="uk-comment-meta uk-subnav uk-subnav-divider uk-margin-remove-top">
                                        <li>640 x 480</li>
                                        <li>${fileSizeHuman(imageSize)}</li>
                                    </ul>
                                </div>
                            </header>
                            <div class="uk-comment-body">

                                <div class="uk-grid uk-child-width-expand@m">
                                    <div>
                                        <div class="uk-inline" style="display: unset">
                                            <span class="uk-form-icon uk-form-icon-flip">%</span>
                                            <input id="nodeScale" class="uk-input uk-form-small" placeholder="Scale">
                                        </div>
                                    </div>
                                    <div>
                                        <input id="nodeId" class="uk-input uk-form-small uk-magin-right" placeholder="Node ID">
                                    </div>
                                    <div>
                                        <input id="nodeType" class="uk-input uk-form-small" placeholder="Type" value="Fiction">
                                    </div>
                                    <div>
                                        <input id="nodeSource" class="uk-input uk-form-small uk-magin-right" placeholder="Source" value="Text">
                                    </div>
                                    <div>
                                        <label class="uk-text-right">
                                            <input id="nodeIsDynamic" class="uk-checkbox uk-margin-small-right" type="checkbox" checked>
                                            Dynamic
                                        </label>
                                    </div>
                                </div>

                                <p><input id="nodeConnections" class="uk-input uk-form-small uk-magin-right"
                                          placeholder="Connection node to this image, enter node-id, seperated by comma. e.g. 21,23,25"></p>

                                <p><textarea id="nodeDesc" class="uk-textarea uk-form-blank" rows="5" style="border-left: dashed 1px #e5e5e5;"
                                             placeholder="Write Description, and tell people about this image"></textarea></p>
                            </div>
                        </article>
                    </div>

                    <div class="uk-width-auto">
                        <div uk-icon="icon: trash" class="uk-align-right uk-margin-top" onclick="removeNode('#node-${uid}')" style="cursor: pointer"></div>
                    </div>

                </div>
            </div>

            </div>
            <!--</li>-->`;

        el_image_node_container.appendChild(newNode);

        // Scroll to bottom
        window.scrollTo(0, document.body.scrollHeight);

        // Show the new node
        anime({
            targets: newNode,
            translateX: [-200, 0]
        });
    }

    // Zoom out animation
    anime({
        targets: '#set-meta-card',
        scale: {
            value: [1.2, 1],
            duration: 2000
        },
        translateX: [-200, 0],
        opacity: [0, 1]
    });

    var barUploadProgress = document.getElementById('js-progressbar');

    UIkit.upload('.js-upload', {

        url: 'data/ImageSecure/upload.php',
        multiple: false,  // todo: multiple upload support
        mime: 'image/*',
        name: 'files[]',
        // type: 'json',

        beforeSend: function () {
            console.log('beforeSend', arguments);
        },
        beforeAll: function () {
            console.log('beforeAll', arguments);
        },
        load: function () {
            console.log('load', arguments);
        },
        error: function () {
            console.log('error', arguments);
        },
        complete: function () {
            console.log('complete', arguments);
        },

        loadStart: function (e) {
            console.log('loadStart', arguments);

            // barUploadProgress.removeAttribute('hidden');
            anime({
                targets: barUploadProgress,
                opacity: 1,
            });
            barUploadProgress.max = e.total;
            barUploadProgress.value = e.loaded;
        },

        progress: function (e) {
            console.log('progress', arguments);

            barUploadProgress.max = e.total;
            barUploadProgress.value = e.loaded;
        },

        loadEnd: function (e) {
            console.log('loadEnd', arguments);

            barUploadProgress.max = e.total;
            barUploadProgress.value = e.loaded;
        },

        completeAll: function () {
            console.log('completeAll', arguments);

            setTimeout(function () {
                // barUploadProgress.setAttribute('hidden', 'hidden');
                anime({
                    targets: barUploadProgress,
                    opacity: 0,
                });
            }, 1000);

            // Insert an image node
            const ret = JSON.parse(arguments[0].response);
            addImageNode(ret.images[0], ret.imgRes[0], ret.fileSize[0], ret.id[0]);
        }

    });

    document.querySelector('#btn-upload').addEventListener('click', function () {
        var payload = {
            'imageFileIds'   : [],
            'nodeTitles'     : [],
            'nodeScales'     : [],
            'nodeIds'        : [],
            'nodeTypes'      : [],
            'nodeSources'    : [],
            'nodeConnections': [],
            'nodeDescritions': [],
        };
        document.querySelectorAll('img#uploadImage').forEach(function (i) {
            payload.imageFileIds.push(i.dataset.imageId);
        });
        document.querySelectorAll('input#nodeTitle'     ).forEach(function (i) {
            payload.nodeTitles.push(i.value)
        });
        document.querySelectorAll('input#nodeScale'     ).forEach(function (i) {
            // todo Validation
            const val = parseFloat(i.value);
            payload.nodeScales.push(val)
        });
        document.querySelectorAll('input#nodeId'        ).forEach(function (i) {
            payload.nodeIds.push(i.value)
        });
        document.querySelectorAll('input#nodeType'      ).forEach(function (i) {
            payload.nodeTypes.push(i.value)
        });
        document.querySelectorAll('input#nodeSource'    ).forEach(function (i) {
            payload.nodeSources.push(i.value)
        });
        document.querySelectorAll('input#nodeConnections').forEach(function (i) {
            var ok = true;
            const arr = [];
            // Validation:
            i.value.split(',').forEach(function (j) {
                const conn_id = trim(j);
                if (conn_id === "") return;
                if (payload.nodeIds.indexOf(conn_id) === -1) {
                    ok = false;
                    console.warn(`id= ${j} not exists`);
                }
                arr.push(conn_id);
            });
            payload.nodeConnections.push(arr)
        });
        document.querySelectorAll('textarea#nodeDesc').forEach(function (i) {
            payload.nodeDescritions.push(i.value)
        });

        // create a new ecosystem
        var el_granularity = document.querySelectorAll('input.form-granularity-option'); //('input[name=radio1]');
        var sel_granularity;
        for (var ix=0; ix<el_granularity.length; ix++ ) {
            if (el_granularity[ix].checked) {
                sel_granularity = el_granularity[ix].dataset['val'];
                break;
            }
        }
        const data = {
            name: document.querySelector('input#form-set-name').value,
            granularity: sel_granularity,
            scale_type: document.querySelector('select#form-scale-type')
                .selectedOptions[0].dataset['val'],
            description: document.querySelector('textarea#form-set-desc').value,
        };

        const node_id_map = {};
        const node_id_index = {};

        ajax('POST', 'data/api.php/records/ecosystem', JSON.stringify(data), false, function (resp) {

            var eco_id = resp;
            console.log(eco_id);
            // todo Do validation of eco_id

            // create each image nodes
            for (var i=0; i<payload.nodeIds.length; i++){
                const data = {
                    scale: payload.nodeScales[i],
                    type: payload.nodeTypes[i],
                    source: payload.nodeSources[i],
                    description: payload.nodeDescritions[i],
                    is_dynamic: 0,  //fixme

                    fk_ecosystem_id: eco_id,
                    fk_image_id: payload.imageFileIds[i]
                };

                const node_id = ajax('POST', 'data/api.php/records/node', JSON.stringify(data), false);
                node_id_index[ i ] = node_id;
                if (trim(payload.nodeIds[i]) !== '') {
                    node_id_map[ payload.nodeIds[i] ] = node_id;
                }
            }

            console.log(node_id_index);

            // update each node's connections
            console.log(payload);
            for (var i=0; i<payload.nodeIds.length; i++){
                if ( payload.nodeConnections[i].length > 0) {
                    // Connections existed
                    const conn_arr = [];

                    // convert the indexes
                    payload.nodeConnections[i].forEach(function (conn_idx) {
                        conn_arr.push(node_id_map[conn_idx]);
                    });

                    ajax('PUT', 'data/api.php/records/node/'+node_id_index[i],
                        JSON.stringify({connections: conn_arr.toString()}),
                        false);
                }

            }

            console.log(payload);
        });

    });

</script>

</body>
</html>
